<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Yuki ‚Äî WP Assistant</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ec4899">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Yuki">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="mobile-web-app-capable" content="yes">
<style>
  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  body {
    font-family: 'Segoe UI', sans-serif;
    background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #0f172a 100%);
    min-height: 100vh; overflow: hidden; user-select: none;
  }
  .bg-particle {
    position: fixed; border-radius: 50%; pointer-events: none;
    animation: drift linear infinite; opacity: 0.12;
  }
  @keyframes drift {
    0%   { transform: translateY(100vh) rotate(0deg); opacity: 0; }
    10%  { opacity: 0.12; }
    90%  { opacity: 0.08; }
    100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
  }
  .demo-label {
    position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
    background: rgba(255,255,255,0.07); backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.1);
    color: rgba(255,255,255,0.5); font-size: 12px;
    padding: 8px 18px; border-radius: 20px; pointer-events: none; white-space: nowrap;
  }

  /* ‚îÄ‚îÄ YUKI CONTAINER ‚îÄ‚îÄ */
  #yukiWrap {
    position: fixed; bottom: 24px; right: 24px;
    width: 120px; height: 173px;
    cursor: grab; z-index: 9999; touch-action: none;
  }
  #yukiWrap:active { cursor: grabbing; }

  /* The actual character image */
  #yukiImg {
    width: 120px; height: 173px;
    object-fit: contain;
    filter: drop-shadow(0 8px 24px rgba(236,72,153,0.45));
    animation: idleFloat 3s ease-in-out infinite;
    transform-origin: center bottom;
    transition: filter 0.3s;
    pointer-events: none;
  }

  /* ‚îÄ‚îÄ IDLE: gentle float ‚îÄ‚îÄ */
  @keyframes idleFloat {
    0%,100% { transform: translateY(0px) rotate(0deg); }
    30%     { transform: translateY(-9px) rotate(-1deg); }
    70%     { transform: translateY(-5px) rotate(1deg); }
  }

  /* ‚îÄ‚îÄ TALKING: excited bounce ‚îÄ‚îÄ */
  #yukiWrap.talking #yukiImg {
    animation: talkBounce 0.45s ease-in-out infinite;
    filter: drop-shadow(0 8px 28px rgba(139,92,246,0.6));
  }
  @keyframes talkBounce {
    0%,100% { transform: translateY(0) rotate(-2deg) scale(1); }
    25%     { transform: translateY(-10px) rotate(2deg) scale(1.04); }
    75%     { transform: translateY(-4px) rotate(-1deg) scale(1.02); }
  }

  /* ‚îÄ‚îÄ THINKING: tilt ‚îÄ‚îÄ */
  #yukiWrap.thinking #yukiImg {
    animation: thinkTilt 1s ease-in-out infinite;
    filter: drop-shadow(0 8px 24px rgba(251,191,36,0.5));
  }
  @keyframes thinkTilt {
    0%,100% { transform: rotate(-5deg) translateY(0); }
    50%     { transform: rotate(5deg) translateY(-6px); }
  }

  /* ‚îÄ‚îÄ DRAGGING ‚îÄ‚îÄ */
  #yukiWrap.dragging #yukiImg {
    animation: dragWobble 0.3s ease-in-out infinite;
    filter: drop-shadow(0 14px 36px rgba(236,72,153,0.7));
  }
  @keyframes dragWobble {
    0%,100% { transform: rotate(-6deg) scale(1.06); }
    50%     { transform: rotate(6deg)  scale(1.06); }
  }

  /* ‚îÄ‚îÄ HAPPY (on greeting) ‚îÄ‚îÄ */
  #yukiWrap.happy #yukiImg {
    animation: happyJump 0.5s ease-in-out 3;
    filter: drop-shadow(0 10px 28px rgba(236,72,153,0.6));
  }
  @keyframes happyJump {
    0%,100% { transform: translateY(0) scale(1); }
    40%     { transform: translateY(-18px) scale(1.08); }
    70%     { transform: translateY(-6px)  scale(1.03); }
  }

  /* ‚îÄ‚îÄ SPEECH BUBBLE ‚îÄ‚îÄ */
  #yukiSpeech {
    position: absolute; bottom: 168px; right: 0;
    background: white; border-radius: 16px 16px 4px 16px;
    padding: 8px 13px; font-size: 12px; font-weight: 700;
    color: #4a1942; box-shadow: 0 6px 20px rgba(0,0,0,0.18);
    white-space: nowrap; pointer-events: none;
    max-width: 210px; white-space: normal; text-align: center; line-height: 1.4;
    opacity: 0; transform: scale(0.75) translateY(8px);
    transition: all 0.3s cubic-bezier(0.34,1.56,0.64,1);
  }
  #yukiSpeech.show { opacity:1; transform: scale(1) translateY(0); }
  #yukiSpeech::after {
    content:''; position:absolute; bottom:-8px; right:18px;
    width:0; height:0;
    border-left: 8px solid transparent;
    border-right: 4px solid transparent;
    border-top: 10px solid white;
  }

  /* Sparkle particles around Yuki */
  .yuki-spark {
    position: absolute; pointer-events: none;
    animation: sparkFloat 2.5s ease-in-out infinite;
    font-size: 14px;
  }
  .yuki-spark:nth-child(1){ top:10px; left:-12px; animation-delay:0s; }
  .yuki-spark:nth-child(2){ top:40px; right:-14px; animation-delay:0.8s; }
  .yuki-spark:nth-child(3){ bottom:50px; left:-8px; animation-delay:1.6s; }
  @keyframes sparkFloat {
    0%,100%{ opacity:0.9; transform:scale(1) rotate(0deg); }
    50%    { opacity:0.3; transform:scale(0.5) rotate(30deg); }
  }

  /* ‚îÄ‚îÄ CHAT PANEL ‚îÄ‚îÄ */
  #chatPanel {
    position: fixed; bottom: 210px; right: 20px;
    width: 340px;
    background: rgba(10,8,25,0.93); backdrop-filter: blur(24px);
    border: 1px solid rgba(236,72,153,0.22);
    border-radius: 20px 20px 6px 20px;
    box-shadow: 0 24px 60px rgba(0,0,0,0.55),
                0 0 0 1px rgba(236,72,153,0.08),
                inset 0 1px 0 rgba(255,255,255,0.05);
    display: flex; flex-direction: column; overflow: hidden;
    transform-origin: bottom right;
    transform: scale(0.8) translateY(20px); opacity:0; pointer-events:none;
    transition: all 0.35s cubic-bezier(0.34,1.56,0.64,1);
    z-index: 9998; max-height: 510px;
  }
  #chatPanel.open { transform:scale(1) translateY(0); opacity:1; pointer-events:all; }

  .c-head {
    padding: 13px 15px;
    background: linear-gradient(135deg, rgba(236,72,153,0.18), rgba(139,92,246,0.18));
    border-bottom: 1px solid rgba(255,255,255,0.05);
    display: flex; align-items: center; gap: 10px;
  }
  .c-head-avatar {
    width: 34px; height: 34px; border-radius: 50%;
    object-fit: cover; border: 2px solid rgba(236,72,153,0.4);
    flex-shrink: 0;
  }
  .c-head-dot {
    width: 7px; height: 7px; border-radius: 50%; background: #10b981;
    box-shadow: 0 0 8px #10b981; flex-shrink: 0;
    animation: glow 2s ease-in-out infinite;
  }
  @keyframes glow { 0%,100%{box-shadow:0 0 6px #10b981}50%{box-shadow:0 0 14px #10b981} }
  .c-head-info { flex:1; }
  .c-head-name { font-size:13px; font-weight:700; color:#fce7f3; }
  .c-head-sub  { font-size:10px; color:rgba(255,255,255,0.38); margin-top:1px; }
  .c-close {
    background:rgba(255,255,255,0.07); border:none; color:rgba(255,255,255,0.45);
    width:26px; height:26px; border-radius:8px; cursor:pointer; font-size:13px;
    display:flex; align-items:center; justify-content:center; transition:all 0.2s;
  }
  .c-close:hover { background:rgba(236,72,153,0.2); color:#f9a8d4; }

  /* API area */
  .api-area {
    padding:11px 14px;
    background:rgba(245,158,11,0.07); border-bottom:1px solid rgba(245,158,11,0.14);
    display:none;
  }
  .api-area.show{ display:block; }
  .api-area p { font-size:11px; color:#fbbf24; margin-bottom:7px; font-weight:600; }
  .api-row { display:flex; gap:6px; }
  .api-inp {
    flex:1; padding:7px 10px; background:rgba(255,255,255,0.06);
    border:1px solid rgba(245,158,11,0.3); border-radius:8px;
    font-size:11px; font-family:monospace; color:#fef3c7;
  }
  .api-inp:focus{ outline:none; border-color:#f59e0b; }
  .api-btn {
    padding:7px 12px; background:#f59e0b; color:#1a1200;
    border:none; border-radius:8px; cursor:pointer; font-size:11px; font-weight:700;
  }

  /* Messages */
  .c-msgs {
    flex:1; overflow-y:auto; padding:13px;
    display:flex; flex-direction:column; gap:10px;
    min-height:190px; max-height:270px; scroll-behavior:smooth;
  }
  .c-msgs::-webkit-scrollbar{ width:3px; }
  .c-msgs::-webkit-scrollbar-thumb{ background:rgba(236,72,153,0.25); border-radius:3px; }

  .msg{ display:flex; gap:8px; align-items:flex-end; }
  .msg.user{ flex-direction:row-reverse; }
  .msg-bub{
    max-width:80%; padding:9px 12px; font-size:12px; line-height:1.5; border-radius:14px;
  }
  .msg.bot  .msg-bub{ background:rgba(236,72,153,0.1); border:1px solid rgba(236,72,153,0.18); color:#fce7f3; border-radius:4px 14px 14px 14px; }
  .msg.user .msg-bub{ background:linear-gradient(135deg,#7c3aed,#4f46e5); color:white; border-radius:14px 4px 14px 14px; }
  .msg-time{ font-size:10px; color:rgba(255,255,255,0.22); margin-top:3px; }
  .msg.user .msg-time{ text-align:right; }

  .msg-avatar{ width:26px; height:26px; border-radius:50%; object-fit:cover; flex-shrink:0; border:1px solid rgba(236,72,153,0.3); }

  .result-card{
    background:rgba(255,255,255,0.04); border:1px solid rgba(236,72,153,0.18);
    border-left:3px solid #ec4899; border-radius:10px; padding:9px 11px; margin-top:6px;
  }
  .rc-no  { font-size:11px; font-weight:700; color:#93c5fd; }
  .rc-desc{ font-size:11px; color:rgba(255,255,255,0.55); margin-top:2px; }
  .rc-tags{ display:flex; gap:5px; flex-wrap:wrap; margin-top:5px; }
  .rc-tag { font-size:10px; padding:2px 7px; border-radius:8px; font-weight:600; background:rgba(236,72,153,0.13); color:#f9a8d4; }
  .rc-tag.g{ background:rgba(16,185,129,0.13); color:#6ee7b7; }
  .rc-tag.b{ background:rgba(59,130,246,0.13); color:#93c5fd; }

  .typing-row{ display:flex; gap:8px; align-items:center; }
  .typing-bub{
    background:rgba(236,72,153,0.08); border:1px solid rgba(236,72,153,0.14);
    border-radius:4px 14px 14px 14px; padding:10px 14px;
    display:flex; gap:4px; align-items:center;
  }
  .typing-bub span{
    width:6px; height:6px; border-radius:50%; background:#ec4899; display:inline-block;
    animation:tdot 1.2s ease-in-out infinite;
  }
  .typing-bub span:nth-child(2){ animation-delay:0.2s; }
  .typing-bub span:nth-child(3){ animation-delay:0.4s; }
  @keyframes tdot{ 0%,60%,100%{transform:translateY(0);opacity:0.4} 30%{transform:translateY(-5px);opacity:1} }

  /* Quick chips */
  .qchips{ padding:9px 13px 5px; display:flex; gap:6px; flex-wrap:wrap; border-top:1px solid rgba(255,255,255,0.05); }
  .qchip{
    font-size:11px; padding:5px 10px; border-radius:14px; cursor:pointer;
    background:rgba(255,255,255,0.04); border:1px solid rgba(236,72,153,0.18);
    color:#f9a8d4; font-weight:500; transition:all 0.2s; white-space:nowrap;
  }
  .qchip:hover{ background:rgba(236,72,153,0.18); border-color:#ec4899; }

  /* Input */
  .c-input-row{
    padding:10px 12px; border-top:1px solid rgba(255,255,255,0.05);
    display:flex; gap:8px; align-items:flex-end;
  }
  .c-textarea{
    flex:1; padding:9px 12px; background:rgba(255,255,255,0.05);
    border:1.5px solid rgba(255,255,255,0.07); border-radius:12px;
    font-size:12px; font-family:inherit; color:white;
    resize:none; max-height:70px; min-height:36px; line-height:1.4;
    transition:border-color 0.2s;
  }
  .c-textarea:focus{ outline:none; border-color:rgba(236,72,153,0.45); }
  .c-textarea::placeholder{ color:rgba(255,255,255,0.18); }
  .send-btn{
    width:36px; height:36px; border-radius:10px; flex-shrink:0;
    background:linear-gradient(135deg,#ec4899,#be185d);
    border:none; cursor:pointer; color:white; font-size:14px;
    display:flex; align-items:center; justify-content:center; transition:all 0.2s;
  }
  .send-btn:hover:not(:disabled){ transform:scale(1.1); box-shadow:0 4px 16px rgba(236,72,153,0.5); }
  .send-btn:disabled{ opacity:0.35; cursor:not-allowed; }
</style>
</head>
<body>

<script>
for(let i=0;i<16;i++){
  const p=document.createElement('div');
  p.className='bg-particle';
  const s=Math.random()*6+2;
  p.style.cssText=`width:${s}px;height:${s}px;left:${Math.random()*100}%;background:${Math.random()>.5?'#ec4899':'#818cf8'};animation-duration:${8+Math.random()*12}s;animation-delay:${Math.random()*10}s;`;
  document.body.appendChild(p);
}
</script>

<div class="demo-label">üå∏ Yuki WP Assistant ‚Äî by Musadi Febriono</div>


<!-- Install PWA Button -->
<div id="installBtn" style="
  display:none; position:fixed; bottom:210px; left:50%; transform:translateX(-50%);
  background:linear-gradient(135deg,#ec4899,#7c3aed);
  color:white; border:none; border-radius:20px; padding:10px 20px;
  font-size:13px; font-weight:700; cursor:pointer; z-index:9997;
  box-shadow:0 4px 20px rgba(236,72,153,0.4);
  align-items:center; gap:8px; white-space:nowrap;
  animation: installPulse 2s ease-in-out infinite;
" onclick="installApp()">
  üì≤ Install Yuki di HP
</div>
<style>
@keyframes installPulse {
  0%,100%{ box-shadow:0 4px 20px rgba(236,72,153,0.4); transform:translateX(-50%) scale(1); }
  50%    { box-shadow:0 6px 28px rgba(236,72,153,0.7); transform:translateX(-50%) scale(1.04); }
}
</style>
<!-- ‚ïê‚ïê YUKI CHARACTER ‚ïê‚ïê -->
<div id="yukiWrap">
  <div id="yukiSpeech"></div>
  <span class="yuki-spark">‚ú¶</span>
  <span class="yuki-spark">‚úß</span>
  <span class="yuki-spark">‚ú¶</span>
  <img id="yukiImg" src="yuki.png" alt="Yuki">
</div>

<!-- ‚ïê‚ïê CHAT PANEL ‚ïê‚ïê -->
<div id="chatPanel">
  <div class="c-head">
    <img class="c-head-avatar" src="yuki.png" alt="Yuki">
    <div class="c-head-dot"></div>
    <div class="c-head-info">
      <div class="c-head-name">Yuki ‚ú® WP Assistant</div>
      <div class="c-head-sub">Powered by Claude AI ¬∑ Online</div>
    </div>
    <button class="c-close" onclick="closeChat()">‚úï</button>
  </div>

  <div class="api-area" id="apiArea">
    <p>üîë Masukkan Anthropic API Key:</p>
    <div class="api-row">
      <input type="password" class="api-inp" id="apiInp" placeholder="sk-ant-api03-...">
      <button class="api-btn" onclick="saveKey()">Simpan</button>
    </div>
  </div>

  <div class="c-msgs" id="cMsgs">
    <div class="msg bot">
      <img class="msg-avatar" src="yuki.png" alt="">
      <div>
        <div class="msg-bub">Halo! Saya <strong>Yuki</strong> üå∏<br>Tanya aku tentang <strong>Work Permit & JSA</strong> ya!</div>
        <div class="msg-time">Sekarang</div>
      </div>
    </div>
  </div>

  <div class="qchips">
    <div class="qchip" onclick="quickAsk(this)">WP pending hari ini</div>
    <div class="qchip" onclick="quickAsk(this)">Cari vendor tertentu</div>
    <div class="qchip" onclick="quickAsk(this)">WP di Gedung 1</div>
    <div class="qchip" onclick="quickAsk(this)">Siapa developer ini?</div>
  </div>

  <div class="c-input-row">
    <textarea class="c-textarea" id="cInput" placeholder="Tanya Yuki apa saja..." rows="1"
      onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
    <button class="send-btn" id="sendBtn" onclick="sendMsg()">‚û§</button>
  </div>
</div>

<script>
  const WEB_APP_URL = '';
  const USER_NAME   = 'demo';
  let apiKey  = localStorage.getItem('yukiKey') || '';
  let isOpen  = false;
  let isBusy  = false;
  let isDrag  = false;
  let dOffX, dOffY;

  const DEMO = [
    {noWpJsa:'K3/JMI2/WP-JSA/0010/2026',judulPekerjaan:'Pemasangan Kabel Listrik',lokasiKerja:'Gedung 1 Lt.3',vendor:'PT Jaya Teknik',k3Status:'APPROVED',p2k3Status:'APPROVED',status:'ONGOING',timestamp:'2026-02-17'},
    {noWpJsa:'K3/JMI2/WP-JSA/0011/2026',judulPekerjaan:'Instalasi Panel Listrik',lokasiKerja:'Gedung 3',vendor:'PT Jaya Teknik',k3Status:'WAITING',p2k3Status:'WAITING',status:'PENDING',timestamp:'2026-02-19'},
    {noWpJsa:'K3/JMI2/WP-JSA/0012/2026',judulPekerjaan:'Perbaikan Atap Baja',lokasiKerja:'Gedung 2 Rooftop',vendor:'CV Bintang Jaya',k3Status:'APPROVED',p2k3Status:'WAITING',status:'PENDING',timestamp:'2026-02-18'},
    {noWpJsa:'K3/JMI2/WP-JSA/0013/2026',judulPekerjaan:'Pengelasan Pipa Gas',lokasiKerja:'Gedung 1 Basement',vendor:'PT Sarana Maju',k3Status:'APPROVED',p2k3Status:'APPROVED',status:'COMPLETE',timestamp:'2026-02-15'},
  ];

  const SYS = `Kamu adalah Yuki, asisten AI imut dan helpful untuk sistem Work Permit & JSA (K3) di PT JMI.
Kamu diciptakan dan dikembangkan oleh Musadi Febriono.

Jika ada yang bertanya tentang developer, pembuat sistem, atau siapa yang membuat aplikasi ini, jawab dengan hangat seperti ini:
"Sistem K3 Digital ini dikembangkan oleh Musadi Febriono üë®‚Äçüíª‚ú®
Beliau adalah developer yang passionate di bidang K3 & digitalisasi sistem keselamatan kerja.
Kamu bisa lihat profil dan portofolio lengkapnya di LinkedIn: https://id.linkedin.com/in/musadif üåü
Jangan sungkan untuk connect ya!"

Jika ada yang bertanya siapa kamu atau siapa yang membuat kamu, jawab:
"Aku Yuki, asisten AI yang dibuat oleh Musadi Febriono untuk membantu pengelolaan Work Permit & JSA di PT JMI! üå∏"

Kemampuanmu:
- Cari Work Permit berdasarkan vendor, lokasi, tanggal, status, atau nomor WP
- Jelaskan status approval (K3/P2K3)
- Bantu filter data WP yang pending, ongoing, complete, atau rejected

Jawab dengan ramah, singkat, bahasa Indonesia, pakai emoji secukupnya. Jangan terlalu panjang.`;

  window.onload = () => {
    if (!apiKey) document.getElementById('apiArea').classList.add('show');
    initDrag();
    setTimeout(() => speech("Hei! Klik aku untuk chat~ üå∏"), 2000);
    setTimeout(() => hideSpeech(), 5000);
    setInterval(() => {
      if (!isOpen && !isDrag) {
        const m = ["Ada yang bisa aku bantu? ‚ú®","Cek WP pending yuk~ üìã","Yuki siap membantu! üí™","Klik aku dong~ üå∏"];
        speech(m[Math.floor(Math.random()*m.length)]);
        setTimeout(hideSpeech, 3500);
      }
    }, 20000);
  };

  function speech(t) {
    const el = document.getElementById('yukiSpeech');
    el.textContent = t; el.classList.add('show');
  }
  function hideSpeech() { document.getElementById('yukiSpeech').classList.remove('show'); }

  function initDrag() {
    const el = document.getElementById('yukiWrap');
    el.addEventListener('mousedown', dStart);
    el.addEventListener('touchstart', dStart, {passive:true});
    document.addEventListener('mousemove', dMove);
    document.addEventListener('touchmove', dMove, {passive:false});
    document.addEventListener('mouseup', dEnd);
    document.addEventListener('touchend', dEnd);
  }
  function dStart(e) {
    const el = document.getElementById('yukiWrap');
    const r  = el.getBoundingClientRect();
    const cx = e.touches ? e.touches[0].clientX : e.clientX;
    const cy = e.touches ? e.touches[0].clientY : e.clientY;
    dOffX = cx - r.left; dOffY = cy - r.top; isDrag = false;
    el._dt = setTimeout(() => { isDrag = true; el.classList.add('dragging'); el.style.transition='none'; }, 130);
  }
  function dMove(e) {
    if (!isDrag) return;
    if (e.touches) e.preventDefault();
    const el = document.getElementById('yukiWrap');
    const cx = e.touches ? e.touches[0].clientX : e.clientX;
    const cy = e.touches ? e.touches[0].clientY : e.clientY;
    const nx = Math.max(0, Math.min(cx-dOffX, window.innerWidth-el.offsetWidth));
    const ny = Math.max(0, Math.min(cy-dOffY, window.innerHeight-el.offsetHeight));
    el.style.left=nx+'px'; el.style.top=ny+'px'; el.style.right='auto'; el.style.bottom='auto';
  }
  function dEnd() {
    const el = document.getElementById('yukiWrap');
    clearTimeout(el._dt); el.classList.remove('dragging'); el.style.transition='';
    if (!isDrag) toggleChat();
    isDrag = false;
  }

  function toggleChat() { isOpen ? closeChat() : openChat(); }
  function openChat() {
    isOpen = true;
    document.getElementById('chatPanel').classList.add('open');
    setExpr('happy'); setTimeout(() => setExpr('idle'), 1500);
    speech("Haii! üå∏"); setTimeout(hideSpeech, 2000);
    reposPanel();
    setTimeout(() => document.getElementById('cInput').focus(), 400);
  }
  function closeChat() {
    isOpen = false;
    document.getElementById('chatPanel').classList.remove('open');
    speech("Sampai nanti! üëã"); setTimeout(hideSpeech, 2500);
  }
  function reposPanel() {
    const yw = document.getElementById('yukiWrap');
    const cp = document.getElementById('chatPanel');
    const r  = yw.getBoundingClientRect();
    let left = r.left - 350; let top = r.top + r.height - 510;
    if (left < 10) left = r.right + 10;
    if (top  < 10) top  = 10;
    if (left+340 > window.innerWidth) left = 10;
    cp.style.left=left+'px'; cp.style.top=top+'px'; cp.style.right='auto'; cp.style.bottom='auto';
  }

  function setExpr(s) {
    const c = document.getElementById('yukiWrap');
    c.classList.remove('talking','thinking','happy');
    if (s !== 'idle') c.classList.add(s);
  }

  function saveKey() {
    const k = document.getElementById('apiInp').value.trim();
    if (!k.startsWith('sk-ant')) { alert('API Key tidak valid!'); return; }
    apiKey = k; localStorage.setItem('yukiKey', k);
    const a = document.getElementById('apiArea');
    a.innerHTML='<p style="color:#6ee7b7">‚úÖ API Key aktif! AI online.</p>';
    a.style.background='rgba(16,185,129,0.07)';
    setTimeout(() => a.classList.remove('show'), 2500);
  }

  async function sendMsg() {
    const inp = document.getElementById('cInput');
    const txt = inp.value.trim();
    if (!txt || isBusy) return;
    addUser(txt); inp.value=''; inp.style.height='auto';
    document.getElementById('sendBtn').disabled=true; isBusy=true;
    setExpr('thinking'); showTyping();
    let data = DEMO;
    if (WEB_APP_URL) {
      try {
        const r = await fetch(WEB_APP_URL+'?action=getDocuments&page=1&pageSize=999&filterStatus=&username='+USER_NAME);
        const j = await r.json(); if(j.success) data=j.data;
      } catch(e){}
    }
    const rep = await callAI(txt, data);
    hideTyping(); setExpr('talking');
    addBot(rep); speech(rep.text.slice(0,36)+(rep.text.length>36?'‚Ä¶':''));
    setTimeout(() => { hideSpeech(); setExpr('idle'); }, 3500);
    document.getElementById('sendBtn').disabled=false; isBusy=false;
  }
  function quickAsk(el) { document.getElementById('cInput').value=el.textContent; sendMsg(); }
  function handleKey(e) { if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMsg();} }
  function autoResize(el) { el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,70)+'px'; }

  async function callAI(q, data) {
    if (!apiKey) return {text:"Masukkan API Key dulu ya~ supaya aku bisa jawab dengan cerdas! üîë",results:[]};
    const ctx = data.slice(0,60).map(d=>`No:${d.noWpJsa}|Judul:${d.judulPekerjaan}|Lokasi:${d.lokasiKerja}|Vendor:${d.vendor||'-'}|Status:${d.status}|Tgl:${d.timestamp}`).join('\n');
    try {
      const r = await fetch('https://api.anthropic.com/v1/messages',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:500,system:SYS+'\n\nData WP:\n'+ctx,messages:[{role:'user',content:q}]})
      });
      const d = await r.json();
      if (d.content?.[0]) { const t=d.content[0].text; return {text:t,results:data.filter(x=>t.includes(x.noWpJsa))}; }
    } catch(e){}
    return {text:"Waduh gagal konek~ Cek API Key & internet ya üôè",results:[]};
  }

  const YUKI_AVATAR = document.getElementById('yukiImg').src;
  function addUser(t) {
    const m=document.getElementById('cMsgs');
    const n=new Date().toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'});
    m.innerHTML+=`<div class="msg user"><div><div class="msg-bub">${esc(t)}</div><div class="msg-time">${n}</div></div></div>`;
    m.scrollTop=m.scrollHeight;
  }
  function addBot(rep) {
    const m=document.getElementById('cMsgs');
    const n=new Date().toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'});
    let cards='';
    if(rep.results?.length) cards=rep.results.map(d=>`<div class="result-card"><div class="rc-no">üìã ${esc(d.noWpJsa)}</div><div class="rc-desc">${esc(d.judulPekerjaan)}</div><div class="rc-tags"><span class="rc-tag b">üìç ${esc(d.lokasiKerja)}</span><span class="rc-tag ${d.status==='COMPLETE'?'g':''}">${d.status}</span><span class="rc-tag">${d.timestamp}</span></div></div>`).join('');
    m.innerHTML+=`<div class="msg bot"><img class="msg-avatar" src="${YUKI_AVATAR}" alt=""><div><div class="msg-bub">${esc(rep.text).replace(/\n/g,'<br>')}${cards}</div><div class="msg-time">${n}</div></div></div>`;
    m.scrollTop=m.scrollHeight;
  }
  function showTyping() {
    const m=document.getElementById('cMsgs');
    m.innerHTML+=`<div class="msg bot typing-row" id="tRow"><img class="msg-avatar" src="${YUKI_AVATAR}" alt=""><div class="typing-bub"><span></span><span></span><span></span></div></div>`;
    m.scrollTop=m.scrollHeight;
  }
  function hideTyping() { document.getElementById('tRow')?.remove(); }
  function esc(t) { return String(t||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
</script>

<script>
// ‚îÄ‚îÄ SERVICE WORKER ‚îÄ‚îÄ
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js')
      .then(r => console.log('SW registered'))
      .catch(e => console.log('SW failed:', e));
  });
}

// ‚îÄ‚îÄ INSTALL PROMPT ‚îÄ‚îÄ
let deferredPrompt;
const installBtn = document.getElementById('installBtn');

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  if (installBtn) installBtn.style.display = 'flex';
});

window.addEventListener('appinstalled', () => {
  if (installBtn) installBtn.style.display = 'none';
  speech('Yuki sudah terpasang di HP kamu! üéâ');
  setTimeout(hideSpeech, 3000);
});

function installApp() {
  if (!deferredPrompt) {
    alert('Untuk install:\n1. Buka di Chrome/Safari\n2. Tap menu (‚ãÆ) ‚Üí "Add to Home Screen"');
    return;
  }
  deferredPrompt.prompt();
  deferredPrompt.userChoice.then(r => {
    deferredPrompt = null;
    if (installBtn) installBtn.style.display = 'none';
  });
}

// ‚îÄ‚îÄ AUTO OPEN CHAT if URL has ?open=chat ‚îÄ‚îÄ
window.addEventListener('load', () => {
  if (location.search.includes('open=chat')) setTimeout(openChat, 800);
});
</script>
</body>
</html>
